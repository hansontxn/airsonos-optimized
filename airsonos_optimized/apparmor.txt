#include <tunables/global>

profile airsonos flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/ssl_certs>

  # Allow execution of the main binary
  /usr/bin/node rix,
  /opt/nodejs/bin/node rix,

  # Allow access to addon files
  /data/** rw,
  /data/airsonos_config.json rw,
  /data/airsonos_optimized_config.json rw,
  /data/options.json r,
  /data/dashboard_config.json rw,

  # Allow access to application directory
  /app/** r,
  /app/lib/** r,
  /app/src/** r,
  /app/config/** r,
  /app/translations/** r,
  /app/node_modules/** r,
  /app/package.json r,
  /app/run.sh rix,

  # Allow access to config and share directories  
  /config/** r,
  /share/** r,
  /ssl/** r,

  # System files required for Node.js
  /etc/passwd r,
  /etc/group r,
  /etc/hosts r,
  /etc/hostname r,
  /etc/resolv.conf r,
  /etc/nsswitch.conf r,
  /etc/services r,
  /etc/protocols r,

  # Required system directories
  /proc/*/stat r,
  /proc/*/status r,
  /proc/*/cmdline r,
  /proc/meminfo r,
  /proc/cpuinfo r,
  /proc/loadavg r,
  /proc/uptime r,
  /proc/version r,
  /proc/sys/kernel/osrelease r,
  /sys/class/net/** r,
  /sys/devices/system/cpu/** r,

  # Temporary files
  /tmp/** rw,
  /var/tmp/** rw,
  owner /tmp/** rw,

  # Device access for audio
  /dev/null rw,
  /dev/zero r,
  /dev/urandom r,
  /dev/random r,

  # Network capabilities
  capability net_bind_service,
  capability net_raw,
  capability net_admin,

  # Network access for Sonos communication
  network inet stream,
  network inet dgram,
  network inet6 stream,
  network inet6 dgram,
  network netlink raw,

  # Unix domain sockets
  network unix stream,
  network unix dgram,

  # Allow binding to specific ports
  network inet stream addr=0.0.0.0 port=5000,
  network inet stream addr=0.0.0.0 port=5001,
  network inet stream addr=0.0.0.0 port=5002,
  network inet stream addr=0.0.0.0 port=8099,
  network inet stream addr=0.0.0.0 port=8098,
  network inet stream addr=0.0.0.0 port=8097,

  # Allow connecting to Sonos devices (typically port 1400-1401)
  network inet stream addr=* port=1400-1401,
  network inet stream addr=* port=80,
  network inet stream addr=* port=443,

  # Multicast for device discovery
  network inet dgram addr=239.255.255.250 port=1900,
  network inet6 dgram addr=ff02::c port=1900,

  # mDNS for service discovery
  network inet dgram addr=224.0.0.251 port=5353,
  network inet6 dgram addr=ff02::fb port=5353,

  # Node.js specific capabilities
  capability setuid,
  capability setgid,
  capability sys_nice,

  # Process management
  capability kill,
  capability sys_ptrace,

  # Memory management
  capability ipc_lock,

  # File system capabilities
  capability dac_override,
  capability fowner,
  capability fsetid,

  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_boot,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_time,
  deny capability mac_admin,
  deny capability mac_override,

  # Deny access to sensitive files
  deny /etc/shadow r,
  deny /etc/gshadow r,
  deny /root/** rw,
  deny /home/** rw,

  # Deny access to other addon data
  deny /addon_configs/** rw,
  deny /backup/** rw,

  # Deny kernel interfaces
  deny /proc/*/mem rw,
  deny /proc/kcore r,
  deny /proc/kallsyms r,
  deny /proc/kmsg r,
  deny /sys/firmware/** r,
  deny /sys/kernel/debug/** rw,

  # Deny mounting
  deny mount,
  deny umount,

  # Deny changing security contexts
  deny capability setpcap,

  # Signal handling
  signal (send) set=(term, kill, int, quit, usr1, usr2) peer=unconfined,
  signal (receive) set=(term, kill, int, quit, usr1, usr2),

  # Child process execution
  /bin/sh rix,
  /bin/bash rix,
  /bin/dash rix,
  /usr/bin/timeout rix,
  /usr/bin/env rix,

  # Allow npm and node operations
  /usr/bin/npm rix,
  /usr/local/bin/npm rix,
  /usr/bin/npx rix,
  /usr/local/bin/npx rix,

  # Package manager access
  /usr/lib/node_modules/** r,
  /usr/local/lib/node_modules/** r,

  # Cache directories
  /home/*/.npm/** rw,
  owner /home/*/.npm/** rw,
  /.npm/** rw,

  # Logging
  /var/log/supervisor/** rw,
  /proc/self/fd/ r,
  /proc/self/fd/* rw,

  # Performance monitoring
  capability sys_resource,
  /proc/*/stat r,
  /proc/*/statm r,
  /proc/*/io r,

  # Health checks
  /app/lib/health-check.js r,
  /app/src/performance_monitor.js r,

  # Configuration files
  /app/config.yaml r,
  /app/config/options.json r,
  /app/config/services.yaml r,
  /app/translations/en.json r,

  # Backup and migration
  /data/*.backup.* rw,
  /config/*.backup.* rw,

  # Worker thread support
  capability sys_nice,
  /proc/sys/kernel/threads-max r,

  # Audio processing
  capability sys_nice,
  /proc/asound/** r,

  # Network quality monitoring
  /proc/net/dev r,
  /proc/net/wireless r,
  /sys/class/net/*/statistics/** r,

  # DNS resolution
  /run/systemd/resolve/stub-resolv.conf r,
  /run/systemd/resolve/resolv.conf r,

  # Time synchronization
  /proc/sys/kernel/random/boot_id r,

  # Container environment
  /.dockerenv r,
  /proc/1/cgroup r,

  # Supervisor communication
  /run/supervisor.sock rw,

  # Site-local customizations
  #include <local/airsonos>
}